var Observ = require('observ')
var handle = require('./lib/handle.js')
var getMessage = require('./lib/get-message.js')
var handleResend = require('./lib/handle-resend.js')
var getValue = require('./lib/get-value.js')
var write = require('./lib/write.js')

module.exports = midiValue

function midiValue(duplexPort, mapping, output){

  var obs = Observ()
  obs.output = output || Observ()

  var outputValues = {}

  var removeListeners = [
    handle(duplexPort, handleData),
    obs.output(updateOutput),
    handleResend(duplexPort, outputValues, clearInput)
  ]

  if (output){
    updateOutput(output())
  }

  obs.destroy = function() {
    removeListeners.forEach(invoke)
  }

  return obs

  /// scoped

  function handleData(data){
    var key = data[0] + '/' + data[1]
    var value = data[2]
    // on some keyboards, there are not three values, only a two value
    if (data[2] === undefined) {
      key = data[0].toString()
      value = data[1]
    }
    if (mapping == key){
      obs.set(value)
    }
  }

  function updateOutput(value){
    value = getValue(value)
    if (outputValues[mapping] !== value){
      outputValues[mapping] = value
      write(duplexPort, getMessage(mapping, value))
    }
  }

  function clearInput(){
    obs.set(null)
  }

}

function invoke(f) {
  f()
}
